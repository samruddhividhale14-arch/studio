/**
 * @fileOverview Firestore Security Rules for AgriSync Farmer Profiles
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model for farmer profiles.
 *   Each farmer profile is stored under a specific user's ID, ensuring that only the
 *   authenticated user can access their own data. This is achieved through path-based
 *   ownership and simple authentication checks.
 *
 * @dataStructure Farmer profiles are nested under `/users/{userId}/farmers/{farmerId}`.
 *   This hierarchical structure simplifies security rules and ensures clear ownership.
 *
 * @keySecurityDecisions
 *   - User listing is implicitly disallowed by the ruleset structure.
 *   - Data validation is relaxed during this prototyping phase, focusing on authorization.
 *   - The rules explicitly deny any write operations with `if false;` if the request doesn't match the signed in user.
 *
 * @denormalizationForAuthorization Not required: Path-based ownership eliminates the need for data denormalization.
 *   The user ID is already present in the document path, allowing for direct access control
 *   based on `request.auth.uid`.
 *
 * @structuralSegregation Not applicable: There is no public vs. private data segregation in this model.
 *   All farmer data is considered private and is stored under the user's private data tree.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rule for securing access to farmer profiles. Ensures that only the owner can read, create, update, or delete a farmer profile.
     * @path /users/{userId}/farmers/{farmerId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create a farmer profile at /users/user_abc/farmers/farmer_123.
     * @allow (get) - Authenticated user with UID 'user_abc' can get the farmer profile at /users/user_abc/farmers/farmer_123.
     * @allow (update) - Authenticated user with UID 'user_abc' can update the farmer profile at /users/user_abc/farmers/farmer_123.
     * @allow (delete) - Authenticated user with UID 'user_abc' can delete the farmer profile at /users/user_abc/farmers/farmer_123.
     * @deny (create) - Authenticated user with UID 'user_xyz' cannot create a farmer profile at /users/user_abc/farmers/farmer_123.
     * @deny (get) - Authenticated user with UID 'user_xyz' cannot get the farmer profile at /users/user_abc/farmers/farmer_123.
     * @deny (update) - Authenticated user with UID 'user_xyz' cannot update the farmer profile at /users/user_abc/farmers/farmer_123.
     * @deny (delete) - Authenticated user with UID 'user_xyz' cannot delete the farmer profile at /users/user_abc/farmers/farmer_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/farmers/{farmerId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidFarmerCreateRequest(userId, farmerId);
      allow update: if isSignedIn() && isExistingOwner(userId) && isFarmerIdImmutable(userId, farmerId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     * @example isOwner('user_abc') returns true if request.auth.uid == 'user_abc'.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Validates that the farmerId in the request matches the document ID in the path and that the userId matches the userId from the request
     * @param {string} userId The user ID from the path.
     * @param {string} farmerId The farmer ID from the path.
     * @returns {boolean} True if the request is valid, false otherwise.
     */
    function isValidFarmerCreateRequest(userId, farmerId) {
        return request.resource.data.id == farmerId && isOwner(userId);
    }

    /**
     * @description Checks if the farmerId is immutable by validating if the farmerId in the resource data matches the farmerId in the existing resource data.
     * @param {string} userId The user ID from the path.
     * @param {string} farmerId The farmer ID from the path.
     * @returns {boolean} True if the farmerId is immutable, false otherwise.
     */
     function isFarmerIdImmutable(userId, farmerId) {
        return request.resource.data.id == resource.data.id;
    }
  }
}